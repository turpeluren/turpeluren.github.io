
const jsondata = '{'+
    '"y2018": {'+
        '"jan1": {'+
            '"n1": "xsvUvrE",'+
            '"n2": "na7Clg7",'+
            '"n3": "zXN6UWC",'+
            '"n4": "oLX18RW",'+
            '"n5": "kIzMRCs",'+
            '"n6": "PTTKDK8",'+
            '"n7": "U0QAFOv",'+
            '"n8": "n0lDiad",'+
            '"n9": "Jvkztea",'+
            '"n10": "n0FPtEp",'+
            '"n11": "",'+
            '"n12": "",'+
            '"n13": "",'+
            '"n14": "",'+
            '"n15": "",'+
            '"n16": "",'+
            '"n17": "",'+
            '"n18": "",'+
            '"n19": "",'+
            '"n20": "",'+
            '"n21": "",'+
            '"n22": "",'+
            '"n23": "",'+
            '"n24": "",'+
            '"n25": "",'+
            '"n26": "",'+
            '"n27": "",'+
            '"n28": "",'+
            '"n29": "",'+
            '"n30": "",'+
            '"n31": ""'+
        '},'+
        '"feb2": {'+
            
        '},'+
        '"mar3": {'+

        '},'+
        '"apr4": {'+
            '"n10": "R68yNfU"'+
        
        '},'+
        '"maj5": {'+

        '},'+
        '"jun6": {'+
            
        '},'+
        '"jul7": {'+

        '},'+
        '"aug8": {'+
            
        '},'+
        '"sep9": {'+

        '},'+
        '"okt10": {'+
            
        '},'+
        '"nov11": {'+

        '},'+
        '"dec12": {'+
            
        '}'+
    '},'+
    '"y2019": {'+
        '"jan1": {'+

        '},'+
        '"feb2": {'+
            
        '},'+
        '"mar3": {'+

        '},'+
        '"apr4": {'+
        
        '},'+
        '"maj5": {'+

        '},'+
        '"jun6": {'+
            
        '},'+
        '"jul7": {'+

        '},'+
        '"aug8": {'+
            
        '},'+
        '"sep9": {'+

        '},'+
        '"okt10": {'+
            
        '},'+
        '"nov11": {'+

        '},'+
        '"dec12": {'+
            
        '}'+
    '},'+
    '"y2020": {'+
        '"jan1": {'+

        '},'+
        '"feb2": {'+
            
        '},'+
        '"mar3": {'+

        '},'+
        '"apr4": {'+
        
        '},'+
        '"maj5": {'+

        '},'+
        '"jun6": {'+
            
        '},'+
        '"jul7": {'+

        '},'+
        '"aug8": {'+
            
        '},'+
        '"sep9": {'+

        '},'+
        '"okt10": {'+
            
        '},'+
        '"nov11": {'+

        '},'+
        '"dec12": {'+
            
        '}'+
    '},'+
    '"y2021": {'+
        '"jan1": {'+
            
        '},'+
        '"feb2": {'+
            
        '},'+
        '"mar3": {'+

        '},'+
        '"apr4": {'+
            
        '},'+
        '"maj5": {'+

        '},'+
        '"jun6": {'+
            
        '},'+
        '"jul7": {'+

        '},'+
        '"aug8": {'+
            
        '},'+
        '"sep9": {'+

        '},'+
        '"okt10": {'+
            
        '},'+
        '"nov11": {'+
            '"n13": "lLHotkQ"'+
        '},'+
        '"dec12": {'+
            '"n3": "ZxLCTHw",'+
            '"n24": "l8Iag8t",'+
            '"n31": "O2f81WH"'+
        '}'+
    '}'+
'}';

const arraydata = [
    ["1 jan 2018", "xsvUvrE"],
    ["2 jan 2018", "na7Clg7"],
    ["3 jan 2018", "zXN6UWC"],
    ["4 jan 2018", "oLX18RW"],
    ["5 jan 2018", "kIzMRCs"],
    ["6 jan 2018", "PTTKDK8"],
    ["7 jan 2018", "U0QAFOv"],
    ["8 jan 2018", "n0lDiad"],
    ["9 jan 2018", "Jvkztea"],
    ["10 jan 2018", "n0FPtEp"],
    ["11 jan 2018", "OWJ5BQc"],
    ["12 jan 2018", "T0NADA5"],
    ["13 jan 2018", "S03eNyx"],
    ["14 jan 2018", "3KY19TQ"],
    ["15 jan 2018", "vY1XybU"],
    ["16 jan 2018", "d985VN4"],
    ["17 jan 2018", "UkLvolh"],
    ["18 jan 2018", "kpmaP5c"],
    ["19 jan 2018", "6hP5niz"],
    ["20 jan 2018", "6apg3OG"],
    ["21 jan 2018", "I8hiZif"],
    ["22 jan 2018", "ncGfZ1j"],
    ["23 jan 2018", "GELgnjH", "There is another image from this day with other lighting.", "gKGjuZ3"],
    ["24 jan 2018", "vikBvin"],
    ["25 jan 2018", "9XrCIIa"],
    
    ["1 feb 2018", "fPhXehd"],
    ["2 feb 2018", "gSN6IEv"],
    ["3 feb 2018", "guqVwMY"],
    ["4 feb 2018", "OVlvNH8"],
    ["5 feb 2018", "wvJhsB5"],
    ["6 feb 2018", "Ugk1AaB"],
    ["7 feb 2018", "EEKdt7M"],
    ["8 feb 2018", "Rk9Qxpd"],
    ["9 feb 2018", "bXcp0We"],
    ["10 feb 2018", "Adzz2K9", "My 17th birthday!"],
    ["11 feb 2018", "hzbAzy9"],
    ["12 feb 2018", "epz76A2"],
    ["13 feb 2018", "EZaiVkb"],
    ["14 feb 2018", "giSX5fh"],
    ["15 feb 2018", "C1qnQi5"],
    ["16 feb 2018", "vjR5Kby"],
    ["17 feb 2018", "BxSZOPJ"],
    ["18 feb 2018", "cUSyC1n"],
    ["19 feb 2018", "l4ttgJ5"],
    ["20 feb 2018", "u1zf0x4"],
    ["21 feb 2018", "wVW1XOm"],
    ["22 feb 2018", "WQK8SA0"],
    ["23 feb 2018", "qQW8mYB"],
    ["24 feb 2018", "2Gjt2zh"],
    ["25 feb 2018", "IGGGuoA"],
    ["26 feb 2018", "vtt9473"],
    ["27 feb 2018", "MKtPopr"],
    ["28 feb 2018", "4u8YJHM"],


    ["10 apr 2018", "R68yNfU"],
    

    ["11 nov 2021", "lLHotkQ"],

    ["3 dec 2021", "ZxLCTHw"],
    ["24 dec 2021", "l8Iag8t"],
    ["31 dec 2021", "O2f81WH"]
];

(function () {
    //'use strict';


    /*const data = JSON.parse(jsondata);*/
    const data = arraydata;
    /*const pointer = ["y2021", "dec12", "n31"];*/
    let pointer = data.length-1;
    const playBtn = document.getElementsByClassName('play')[0];
    const playIcon = playBtn.children[0];
    const backBtn = document.getElementsByClassName('backStep')[0];
    const forwBtn = document.getElementsByClassName('frontStep')[0];
    const firstBtn = document.getElementsByClassName('firstStep')[0];
    const lastBtn = document.getElementsByClassName('lastStep')[0];
    const date = document.getElementById('date');
    const imgContainer = document.getElementsByClassName('imgContainer')[0];
    const img = document.getElementById('image');
    const oldimg = document.getElementById('lastImage');
    const slider = document.getElementById('fpsSlider').children[1];
    const onionSlider = document.getElementById('onionSlider').children[1];
    const settingsBtn = document.getElementById('settings');
    const settingsBackground = document.getElementsByClassName('settingsBackground')[0];
    const settingsMenu = document.getElementsByClassName('settingsMenu')[0];
    let imgURL = "";

    playBtn.addEventListener('click', play);
    backBtn.addEventListener('click', stepBack);
    forwBtn.addEventListener('click', stepForward);
    firstBtn.addEventListener('click', gotoFirst);
    lastBtn.addEventListener('click', gotoLast);
    slider.addEventListener('input', updateFps);
    onionSlider.addEventListener('input', updateOnionTime);
    settingsBtn.addEventListener('click',toggleSettings);
    settingsBackground.addEventListener('click', toggleSettings);
    oldimg.style.opacity = 0;

    document.addEventListener('keydown', function(event) {
        if(event.key == "s") {
            toggleSettings();
        }
        if(event.keyCode == 32) {
            play();
        }
    });

    img.addEventListener("load", event => {
        //onload for the image, if playing change to next image
        var image = document.querySelector('img');
        var isLoaded = image.complete && image.naturalHeight !== 0;
        if (isPlaying) {
            changeImage(1);
            animateLastFrame(0);
            //set timeout to not change image too fast
            isPlaying = false;
            clearTimeout(playTimeout);
            playTimeout = setTimeout(resumePlaying, fps);
        }
    });

    var yy, mm, dd;
    let size = 'h'; //t: thumbnail, m: medium, l: large, h: huge: tom string: stÃ¶rsta
    var playTimeout;
    var isPlaying = false;
    var fps = (1000 / slider.value);
    var id = [];
    var onionskin = [];
    var adir = [];
    var pos = [];
    var onionTime = onionSlider.value;

    updateImage();

    function toggleSettings() {
        settingsMenu.classList.toggle('hidden');
        settingsBackground.classList.toggle('hidden');
    }

    function updateImage() {
        // display image from the json object
        //  using the pointer array
        //imgURL = eval("data."+pointer[0]+"."+pointer[1]+"."+pointer[2]);
        oldimg.src = img.src;
        imgURL = data[pointer][1];
        console.log(data[pointer][1])
        img.src = "";
        img.src = "https://imgur.com/" + imgURL + size + ".jpg";

        //update date
        date.innerHTML = getDate();
    }

    function animateLastFrame(dir) {
        var nr = onionskin.length;
        console.log(nr)
        onionskin[nr] = document.createElement('img');
        onionskin[nr].classList.add('lastImage');
        onionskin[nr].src = oldimg.src;
        onionskin[nr].style.zIndex = String(1000000000-nr);
        imgContainer.appendChild(onionskin[nr]);
        adir[nr] = dir;
        pos[nr] = 0;
        //var width = onionskin[nr].offsetWidth;
        clearInterval(id[nr]);
        id[nr] = setInterval(function(){frame(nr)}, 1);
        function frame(nr) {
            if (Math.abs(pos[nr]) >= 1) {
                clearInterval(id[nr]);
                console.log(1-Math.abs(pos[nr])/1)
                onionskin[nr].remove();
            } else {
                pos[nr] += 1/onionTime*4; //Math.round(slider.value^0.2)+3; //pos[nr]/5;
                //onionskin[nr].style.left = -adir[nr]*pos[nr] + 'px';
                onionskin[nr].style.opacity = 1-pos[nr];
            }
        }
    }

    function updateFps() {
        fps = (1000 / slider.value);
    }

    function updateOnionTime() {
        onionTime = onionSlider.value;
    }

    function play() {
        if (playBtn.classList.contains('paused')) {
            //pause
            playBtn.classList.remove('paused');
            clearTimeout(playTimeout);
            isPlaying = false;
            size = 'h';
            updateImage();
        } else {
            //play
            playBtn.classList.add('paused');
            resumePlaying();
            size = 'l';
        }
    }

    function resumePlaying() {
        //when the minimum interval has passed for playing 
        //  goto next image
        changeImage(1);
        animateLastFrame(0);
        isPlaying = false;
        playTimeout = setTimeout(resumePlaying, fps);
    }

    function gotoFirst() {
        /*pointer[0] = 'y2018';
        pointer[1] = 'jan1';
        pointer[2] = 'n1';*/
        pointer = 0;
        
        updateImage();
        animateLastFrame(0);
    }

    function gotoLast() {
        /*pointer[0] = 'y2021';
        pointer[1] = 'dec12';
        pointer[2] = 'n31';*/
        pointer = data.length-1;
        
        updateImage();
        animateLastFrame(0);
    }

    function getDate() {
        let date = data[pointer][0];
        return date;
    }

    /*function getDate() {
        //day
        let date = pointer[2].slice(1) + " ";
        //month
        if (pointer[1] === "jan1") {
            date += "januray";
        } else if (pointer[1] === "feb2") {
            date += "february";
        } else if (pointer[1] === "mar3") {
            date += "mars";
        } else if (pointer[1] === "apr4") {
            date += "april";
        } else if (pointer[1] === "maj5") {
            date += "may";
        } else if (pointer[1] === "jun6") {
            date += "june";
        } else if (pointer[1] === "jul7") {
            date += "july";
        } else if (pointer[1] === "aug8") {
            date += "august";
        } else if (pointer[1] === "sep9") {
            date += "september";
        } else if (pointer[1] === "okt10") {
            date += "october";
        } else if (pointer[1] === "nov11") {
            date += "november";
        } else if (pointer[1] === "dec12") {
            date += "december";
        }
        //year
        date += " " + pointer[0].slice(1);
        return date;
    }*/

    function stepForward() {
        //go through the json
        //updateDate();

        changeImage(1);
        animateLastFrame(1);
    }

    function stepBack() {
        //go through the json
        //updateDate();

        changeImage(-1);
        animateLastFrame(-1);
    }

    function updateDate() {
        yy = parseInt(pointer[0].slice(1));
        mm = parseInt(pointer[1].slice(3));
        dd = parseInt(pointer[2].slice(1));
    }

    function changeImage(dir) {
        pointer += dir;
        if (pointer > data.length-1) pointer = 0;
        if (pointer < 0) pointer = data.length-1;
        updateImage();
    }

    /*function gotoCorrectDayInMonth(dir) {
        yy = parseInt(pointer[0].slice(1));
        mm = parseInt(pointer[1].slice(3));
        dd = parseInt(pointer[2].slice(1));

        // while previous day data does not exist & before 1st of the month
        while (!eval("data."+pointer[0]+"."+pointer[1]+".n"+String(dd+dir)) && dd > -1 && dd < 33) {
            // step back one day in the same month
            pointer[2] = "n"+String(dd+dir);
            dd = dd + dir;
        }
        if (eval("data."+pointer[0]+"."+pointer[1]+".n"+String(dd+dir))) {
            //return if landed on a valid day
            pointer[2] = "n"+String(dd+dir);
            updateImage()
            return
        } else {
            //else goto next month
            gotoNextMonth(dir)
            gotoCorrectDayInMonth(dir)
        }
    }*/

    //logs the month before the pointer
    function gotoNextMonth(dir) {
        if (mm == 1 && dir < 0) {
            gotoNextYear(dir);
        }
        if (mm == 12 && dir > 0) {
            gotoNextYear(dir);
        }
        for (key in Object.keys(data.y2021)) {
            if (Object.keys(data.y2021)[key].includes(String(mm+dir))) {
                //set month pointer
                pointer[1] = Object.keys(data.y2021)[key];
                //reset day pointer 
                if (dir > 0) {
                    pointer[2] = 'n0';
                } else {
                    pointer[2] = 'n32';
                }
                updateDate();
                /*console.log(mm + " gotoNextMonth")*/
                return
            }
        }
    }

    function gotoNextYear(dir) {
        if (yy == 2018 && dir < 0) {
            //loop to end
            //reset all pointers
            pointer[0] = 'y2022';
            pointer[1] = 'dec13';
            pointer[2] = 'n32';
            updateDate();
        }
        if (yy == 2021 && dir > 0) {
            //loop to start
            //reset all pointers
            pointer[0] = 'y2017';
            pointer[1] = 'jan0';
            pointer[2] = 'n0';
            updateDate();
        }
        for (key in Object.keys(data)) {
            if (Object.keys(data)[key].includes(String(yy+dir))) {
                //set month pointer
                pointer[0] = Object.keys(data)[key];
                //reset day pointer 
                if (dir > 0) {
                    pointer[1] = 'jan0';
                    pointer[2] = 'n0';
                } else {
                    pointer[1] = 'dec13';
                    pointer[2] = 'n32';
                }
                updateDate();
                return
            }
        }
    }

})();